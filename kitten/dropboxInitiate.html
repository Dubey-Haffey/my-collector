<script>
// get dropbox token for user
var CLIENT_ID = '6xumb4iloq9sz1u';

function dropbox_login(message){
  if(typeof(message) == "undefined"){
    var message = "You need to be logged in to dropbox to access your experiments";
  }
  var dbx = new Dropbox({ clientId: CLIENT_ID });
  if(developer_obj.context == "oCollector" |
     developer_obj.context == "github"){
    var local_website = document.URL

    var authUrl = dbx.getAuthenticationUrl(document.URL);
    document.getElementById('authlink').href = authUrl;
    bootbox.confirm(message,function(response){
      if(response){
        $("#authlink")[0].click();
      }
    });
  } else {
    //alert("it's all goood");
  }
}

function getAccessTokenFromUrl() { // Parses the url and gets the access token if it is in the urls hash
 return utils.parseQueryString(window.location.hash).access_token;
}
function isAuthenticated() { // If the user was just redirected from authenticating, the urls hash will contain the access token.
  return !!getAccessTokenFromUrl();
}


function check_authenticated(){
  if(isAuthenticated()){
    help_div_content = $(".help_general").html();
    startup_dialog = bootbox.dialog({
      title: 'Welcome!',
      message: '<p id="startup_prog"><i class="fa fa-spin fa-spinner"></i> Loading your uberMegaFile <br><br> Refresh page if this message is here for a while</p>' +
      help_div_content +
      '<button class="btn btn-primary change_tip">Previous</button>' +
      '<button class="btn btn-primary change_tip">Next</button>' +
      "<button class='btn btn-primary' id='startup_btn' style='display:none'>Start!</button>"
    });
    $(".change_tip").on("click",function(){
      if(this.innerHTML == "Next"){
        help_obj.tip_no++;
      } else {
        help_obj.tip_no--;
      }
      help_obj.tip_no = help_obj.tip_no < 0 ? help_obj.main.length - 1
                      : help_obj.tip_no == help_obj.main.length ? 0
                      : help_obj.tip_no;

      $(".general_tip").hide();
      $(".tip"+help_obj.tip_no).show();
    });
  // Create an instance of Dropbox with the access token and use it to
    // fetch and render the files in the users root directory.
    var dbx = new Dropbox({ accessToken: getAccessTokenFromUrl() });

    dbx.usersGetCurrentAccount()
    .then(function(account_info){
      $("#dropbox_account_email").html(account_info.email);
      $("#startup_prog").html("Dropbox account: <a href='https://www.dropbox.com/home/Apps/Open-Collector' target='_blank'>" + account_info.email + "</a> <button class='btn btn-info' id='intro_switch_dbx'>Switch account</button>");
      $("#intro_switch_dbx").on("click",function(){
        dbx.setClientId(CLIENT_ID); // i think is necessary
        if(local_website.indexOf("localhost") !== -1){
          local_website += "/www";
        }

        authUrl = dbx.getAuthenticationUrl(document.URL);
        authUrl += "&force_reauthentication=true";
        document.getElementById('authlink').href = authUrl;
        $("#authlink")[0].click();
      });
      initiate_uberMegaFile(); //detect mega_uber file
    })
    .catch(function(error){
      console.dir("Dropbox not logged in yet");
      console.dir(error);
    });

    $_GET = window.location.href.substr(1).split("&").reduce((o,i)=>(u=decodeURIComponent,[k,v]=i.split("="),o[u(k)]=v&&u(v),o),{});



  }	else {
    // Set the login anchors href using dbx.getAuthenticationUrl()
    dropbox_login();
  }
}
switch(developer_obj.context){
  case "oCollector":
  case "github":
    check_authenticated();
    break;
}
</script>